#!/bin/sh

# ====== Fungsi install pakej jika belum terpasang ======
install_pkg() {
    PKG="$1"
    if opkg list-installed | grep -q "^${PKG} "; then
        echo "[SKIP] ${PKG} sudah terpasang."
    else
        echo "[INSTALL] ${PKG}..."
        opkg install "$PKG"
    fi
}

# ====== Fungsi install NAS ======
install_nas() {
    MIN_SPACE=150
    echo "[INFO] Semak ruang storage sebelum pemasangan pakej NAS..."
    FREE_SPACE=$(df /overlay | awk 'NR==2 {print int($4/1024)}')  # dalam MB
    echo "[INFO] Ruang kosong: ${FREE_SPACE}MB"

    if [ "$FREE_SPACE" -lt "$MIN_SPACE" ]; then
        echo "[ERROR] Ruang tidak mencukupi untuk pemasangan pakej NAS."
        echo "[INFO] Perlukan sekurang-kurangnya ${MIN_SPACE}MB."
        echo "[SKIP] Pakej NAS tidak dipasang."
    else
        echo "[OK] Ruang mencukupi. Mula pasang pakej NAS..."
        install_pkg python3-light
        install_pkg python3-pip
        install_pkg aria2
        install_pkg ariang
        install_pkg luci-app-aria2
        install_pkg minidlna
        install_pkg luci-app-minidlna
        install_pkg qbittorrent
        install_pkg luci-app-qbittorrent
        install_pkg autosamba
        install_pkg luci-app-samba4
        echo "[DONE] Pakej NAS selesai dipasang."

        echo "[INFO] Menulis semula konfigurasi ke /etc/config/aria2..."
        cat << 'EOF' > /etc/config/aria2
config aria2 'main'
	option enabled '0'
	option user 'aria2'
	option dir '/mnt/sda1/aria2'
	option config_dir '/var/etc/aria2'
	option bt_enable_lpd 'true'
	option enable_dht 'true'
	option follow_torrent 'true'
	option file_allocation 'none'
	option save_session_interval '30'
	option enable_logging '0'
	option rpc_auth_method 'none'
	option rpc_secure 'false'
	option enable_proxy '0'
	option check_certificate 'false'
	option enable_dht6 'false'
	option enable_peer_exchange 'true'
EOF
        echo "[OK] Konfigurasi ditulis semula ke /etc/config/aria2."
    fi
}

# ====== Fungsi install Network ======
install_https_dns_proxy() {
    install_pkg luci-app-https-dns-proxy
}

install_adblock_fast() {
    install_pkg coreutils-sort
    install_pkg gawk
    install_pkg grep
    install_pkg sed
    install_pkg luci-app-adblock-fast
}

# ====== Fungsi install Clash Converter ======
install_clash_converter() {
    if [ -f "/usr/lib/lua/luci/controller/clash_converter.lua" ]; then
        echo "[SKIP] Clash Converter sudah wujud."
    else
        echo "[INSTALL] Memasang Clash Converter..."
        wget -O /tmp/Install.sh https://raw.githubusercontent.com/Razifadm/ClashConverter/main/Install.sh \
            && chmod +x /tmp/Install.sh \
            && sh /tmp/Install.sh
    fi
}

# ====== Fungsi install ModNssVpn ======
install_modnssvpn() {
    if [ -f "/usr/bin/modipv4.sh" ]; then
        echo "[SKIP] ModNssVpn sudah wujud."
    else
        echo "[INSTALL] Memasang ModNssVpn..."
        wget -O /tmp/Install.sh https://raw.githubusercontent.com/Razifadm/3ModNssVpn/main/Install.sh \
            && chmod +x /tmp/Install.sh \
            && sh /tmp/Install.sh
    fi
}

# ====== Mula skrip ======
opkg update  # sekali sahaja

# Auto install NAS
install_nas

echo
echo "==============================="
echo " Pilih Pakej Network & Tambahan"
echo "==============================="

# ====== https-dns-proxy ======
if opkg list-installed | grep -q "^https-dns-proxy "; then
    echo "[SKIP] https-dns-proxy sudah terpasang."
else
    read -p "Pasang https-dns-proxy? (y/n): " ans
    [ "$ans" = "y" ] || [ "$ans" = "Y" ] && install_https_dns_proxy || echo "[SKIP] https-dns-proxy tidak dipasang."
fi

# ====== adblock-fast ======
if opkg list-installed | grep -q "^adblock-fast "; then
    echo "[SKIP] adblock-fast sudah terpasang."
else
    read -p "Pasang adblock-fast? (y/n): " ans
    [ "$ans" = "y" ] || [ "$ans" = "Y" ] && install_adblock_fast || echo "[SKIP] adblock-fast tidak dipasang."
fi

# ====== Clash Converter (bergantung pada OpenClash) ======
if opkg list-installed | grep -q "^luci-app-openclash "; then
    echo "[INFO] OpenClash ditemui."
    if [ -f "/usr/lib/lua/luci/controller/clash_converter.lua" ]; then
        echo "[SKIP] Clash Converter sudah wujud."
    else
        read -p "OpenClash ada. Pasang Clash Converter juga? (y/n): " ans
        [ "$ans" = "y" ] || [ "$ans" = "Y" ] && install_clash_converter || echo "[SKIP] Clash Converter tidak dipasang."
    fi
else
    echo "[SKIP] OpenClash tidak dijumpai, Clash Converter tidak akan dipasang."
fi

# ====== ModNssVpn ======
if [ -f "/usr/bin/modipv4.sh" ]; then
    echo "[SKIP] ModNssVpn sudah wujud."
else
    read -p "Pasang ModNssVpn? (y/n): " ans
    [ "$ans" = "y" ] || [ "$ans" = "Y" ] && install_modnssvpn || echo "[SKIP] ModNssVpn tidak dipasang."
fi

echo "[DONE] Semua proses pemasangan selesai."
